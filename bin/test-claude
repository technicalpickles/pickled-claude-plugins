#!/bin/bash
# test-claude - Run Claude Code with isolated test configuration
#
# This wrapper sets up an isolated Claude config directory with all
# local plugins installed, useful for testing plugin hooks.
#
# Usage:
#   ./bin/test-claude              # Setup (if needed), install plugins, start claude
#   ./bin/test-claude --clean      # Remove test config and start fresh
#   ./bin/test-claude -p "prompt"  # Pass args to claude

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_CONFIG="$REPO_ROOT/tmp/test-claude-config"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() { echo -e "${GREEN}[test-claude]${NC} $*"; }
warn() { echo -e "${YELLOW}[test-claude]${NC} $*"; }
error() { echo -e "${RED}[test-claude]${NC} $*" >&2; }

usage() {
    cat << EOF
Usage: test-claude [OPTIONS] [CLAUDE_ARGS...]

Run Claude Code with an isolated test configuration.
Automatically sets up config and installs all local plugins on first run.

Options:
  --clean       Remove test config (next run will reinitialize)
  --help        Show this help message

Examples:
  test-claude                      # Setup + install + run claude
  test-claude -p "test prompt"     # Run with print mode
  test-claude --clean              # Remove test config
EOF
}

setup_config() {
    log "Setting up test config..."

    # Create directories
    mkdir -p "$TEST_CONFIG/plugins/cache"
    mkdir -p "$TEST_CONFIG/plugins/marketplaces"

    # Symlink our repo as a marketplace
    ln -sf "$REPO_ROOT" "$TEST_CONFIG/plugins/marketplaces/local-test"

    # Create known_marketplaces.json
    cat > "$TEST_CONFIG/plugins/known_marketplaces.json" << EOF
{
  "local-test": {
    "source": {
      "source": "directory",
      "path": "$REPO_ROOT"
    },
    "installLocation": "$TEST_CONFIG/plugins/marketplaces/local-test",
    "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
  }
}
EOF

    # Create settings.json with bedrock settings from global config
    GLOBAL_SETTINGS="$HOME/.claude/settings.json"

    if [ -f "$GLOBAL_SETTINGS" ]; then
        # Extract bedrock-related settings from global config
        ENV_SETTINGS=$(jq '.env // {}' "$GLOBAL_SETTINGS")
        AWS_AUTH=$(jq -r '.awsAuthRefresh // empty' "$GLOBAL_SETTINGS")

        # Build settings with bedrock config
        cat > "$TEST_CONFIG/settings.json" << EOF
{
  "env": $ENV_SETTINGS,
  $([ -n "$AWS_AUTH" ] && echo "\"awsAuthRefresh\": \"$AWS_AUTH\",")
  "permissions": {
    "allow": [
      "Bash(echo:*)",
      "Bash(git status:*)",
      "Bash(ls:*)",
      "Bash(pwd:*)",
      "Bash(uv run:*)"
    ]
  },
  "hooks": {}
}
EOF
    else
        # Fallback to minimal settings
        cat > "$TEST_CONFIG/settings.json" << EOF
{
  "permissions": {
    "allow": [
      "Bash(echo:*)",
      "Bash(git status:*)",
      "Bash(ls:*)",
      "Bash(pwd:*)",
      "Bash(uv run:*)"
    ]
  },
  "hooks": {}
}
EOF
    fi

    # Create empty installed_plugins.json
    echo '{"version": 2, "plugins": {}}' > "$TEST_CONFIG/plugins/installed_plugins.json"
}

install_all_plugins() {
    log "Installing plugins from local-test marketplace..."

    # Find all plugins with .claude-plugin directories
    for plugin_dir in "$REPO_ROOT"/plugins/*/; do
        if [ -d "$plugin_dir/.claude-plugin" ]; then
            plugin_name=$(basename "$plugin_dir")
            log "  Installing $plugin_name..."
            CLAUDE_CONFIG_DIR="$TEST_CONFIG" claude plugin install "$plugin_name@local-test" 2>/dev/null || {
                warn "  Failed to install $plugin_name (may not be in marketplace.json)"
            }
        fi
    done
}

clean_config() {
    warn "Removing test configuration..."
    rm -rf "$TEST_CONFIG"
    log "Clean complete. Next run will reinitialize."
}

# Parse arguments
case "${1:-}" in
    --clean)
        clean_config
        exit 0
        ;;
    --help|-h)
        usage
        exit 0
        ;;
esac

# Setup if needed
if [ ! -d "$TEST_CONFIG" ]; then
    setup_config
    install_all_plugins
    log "Setup complete!"
fi

# Run claude with test config
log "Starting claude with test config..."
exec env CLAUDE_CONFIG_DIR="$TEST_CONFIG" claude "$@"
